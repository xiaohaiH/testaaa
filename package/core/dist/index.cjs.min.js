"use strict";var e=require("vue-demi");const t="2.7"===e.version.slice(0,3),a="condition-wrapper";function l(e){return e}function r(e){return e}const i={realtime:{type:Boolean,default:void 0},searchAtDatumChanged:{type:Boolean,default:void 0},backfill:{type:Object},toast:{type:Function,default:void 0}};function n(e,t){return Array.isArray(e)?e.filter(Boolean).length?e:t:"number"==typeof e?e:e||t}function u(e,t,a="children"){for(const l of e){if(t(l))return[l];if(l[a]?.length){const e=u(l[a],t);if(e.length)return e.unshift(l),e}}return[]}function o(t){const a=e.ref();return e.computed({set(e){a.value=e},get:()=>void 0===a.value?void 0!==t.defaultValue?"function"==typeof t.defaultValue?t.defaultValue(t.query,t.backfill):t.defaultValue:void 0:a.value})}function d(t,a){const l=e.ref("boolean"==typeof t.disabled&&t.disabled),r=e.ref("boolean"==typeof t.hide&&t.hide),i=()=>({query:t.query,backfill:t.backfill,option:a}),n=()=>{if("function"==typeof t.hide){r.value!==t.hide(i())&&(r.value=t.hide(i()))}else if("function"==typeof t.disabled){l.value!==t.disabled(i())&&(l.value=t.disabled(i()))}};let u=[e.watch((()=>t.query),n,{immediate:!0,deep:!0}),e.watch((()=>[t.disabled,t.hide]),((e,t)=>{e[0]!==t[0]&&(l.value="boolean"==typeof e[0]&&e[0],e[0]),e[1]!==t[1]&&(r.value="boolean"==typeof e[1]&&e[1],e[1]),n()}))];return e.onBeforeUnmount((()=>(u.forEach((e=>e())),u=[]))),{insetDisabled:l,insetHide:r}}function s(t=!0){const a=e.ref(t);return{flag:a,updateFlag:()=>{a.value=!t,e.nextTick((()=>{a.value=t}))}}}function p(e){return e?.toString()??""}const c={field:{type:String,required:!0},query:{type:Object,required:!0},backfill:{type:Object},disabled:{type:[Boolean,Function]},hide:{type:[Boolean,Function]},depend:{type:Boolean},dependFields:{type:[String,Array]},resetToInitialValue:{type:[Boolean]},emptyValue:{type:[String,Number,null,void 0]},validator:{type:[Function]},customGetQuery:{type:Function},defaultValue:{type:[String,Array,Function]}},f={...c,fields:{type:[Array]},backfillToValue:{type:Function,default:e=>e},multiple:{type:Boolean,default:void 0},options:{type:Array,default:()=>[]},getOptions:{type:Function}};function y(e){return e?.toString()??""}const v={...c,fields:{type:[Array]},valueKey:{type:String,required:!0},childrenKey:{type:String},emitPath:{type:[Boolean],default:!1},options:{type:Array,default:()=>[]},getOptions:{type:Function}};exports.IS_COMPOSITION_VERSION=t,exports.commonProps=c,exports.defineCommonMethod=r,exports.defineProvideValue=l,exports.emptyToValue=n,exports.getChained=u,exports.getNode=function(t,...a){return"function"==typeof t?t(...a):"string"==typeof t?t:e.markRaw(t)},exports.plainProps=f,exports.provideKey=a,exports.treeProps=v,exports.usePlain=function(t){const l=e.inject(a),r=o(t),i=t.backfill&&(t.fields?.length?t.fields.map((e=>t.backfill[e])).filter(Boolean):t.backfill[t.field]),u=e.ref(i||(void 0!==t.defaultValue?r.value:t.multiple?[]:"").slice()),c=e.ref([]),f=e.computed((()=>c.value.length?c.value:t.options)),y=()=>t.customGetQuery?t.customGetQuery(u.value,n,t):t.multiple&&t.fields?t.fields.reduce(((e,a,l)=>(e[a]=n(u.value?.[l],t.emptyValue),e)),{}):{[t.field]:n(u.value,t.emptyValue)},{flag:v,updateFlag:h}=s(),{flag:g,updateFlag:m}=s(),b={reset(){const{multiple:e}=t;h(),m(),u.value=t.resetToInitialValue&&r.value?.slice()||(e?[]:"")},updateWrapperQuery(){h(),l&&Object.entries(y()).forEach((([e,t])=>l.updateQueryValue(e,t)))},get validator(){return t.validator},getQuery:y};l?.register(b);const{insetDisabled:Q,insetHide:S}=d(t,b);!i&&t.defaultValue&&b.updateWrapperQuery();const k=[];function V(e){t.getOptions?.((e=>{const t=u.value;u.value=void 0,c.value=e||[],u.value=t}),t.query||{},{trigger:e,change:(e,t)=>{t&&(r.value=e),w(e)},search:(e,t)=>{t&&(r.value=e),F(e),l?.search()}})}function F(e){e!==u.value&&(u.value=e,b.updateWrapperQuery())}function w(e){F(e),l?.insetSearch()}return e.onBeforeUnmount((()=>k.forEach((e=>e())))),k.push(e.watch((()=>t.field),((e,t)=>{e!==t&&l?.removeUnreferencedField(t),b.updateWrapperQuery()}))),k.push(e.watch((()=>[t.fields||t.field,t.fields?t.fields.map((e=>t.query[e])).filter(Boolean):t.query[t.field]]),(([e,a],[l])=>{const r=t.backfillToValue(a,e,t.query);e.toString()===l.toString()&&p(r)!==p(u.value)&&v.value&&(u.value=r)}))),k.push(e.watch((()=>[t.fields||t.field,t.fields?t.fields.map((e=>t.backfill?.[e])).filter(Boolean):t.backfill?.[t.field]]),(([e,a],[l])=>{const r=t.backfillToValue(a,e,t.backfill);e.toString()===l.toString()&&p(r)!==p(u.value)&&(m(),F(r))}))),k.push(e.watch((()=>[t.depend,t.dependFields,t.dependFields&&[].concat(t.dependFields).map((e=>t.query?.[e])).join(",")||""]),(([e,a,l],[r,i,n])=>{g.value&&l!==n&&(V("depend"),e===r&&a?.toString()===i?.toString()&&void 0!==u.value&&""!==u.value.toString()&&F(t.multiple?[]:""))}))),k.push(e.watch((()=>t.getOptions),V.bind(null,"initial"),{immediate:!0})),{wrapper:l,option:b,checked:u,getQuery:y,insetDisabled:Q,insetHide:S,finalOption:f,updateCheckedValue:F,change:w,reset:b.reset}},exports.useTree=function(t){const l=e.inject(a),r=o(t),i=e.ref([]),p=e.ref([]),c=e.computed((()=>p.value.length?p.value:t.options)),f=()=>V.value||r.value?t.customGetQuery?t.customGetQuery(i.value,n,t):t.fields?.length?t.fields.reduce(((e,a,l)=>Object.assign(e,{[a]:n(i.value[l],t.emptyValue)})),{}):{[t.field]:n(t.emitPath?[...i.value]:i.value.slice(-1)[0],t.emptyValue)}:{},{flag:v,updateFlag:h}=s(),{flag:g,updateFlag:m}=s(),b={reset(){return h(),m(),i.value=t.resetToInitialValue&&r.value?.slice()||[],this},get validator(){return t.validator},updateWrapperQuery(){h(),l&&Object.entries(f()).forEach((([e,t])=>l.updateQueryValue(e,t)))},getQuery:f};l?.register(b);const{insetDisabled:Q,insetHide:S}=d(t,b),k=[];e.onBeforeUnmount((()=>k.forEach((e=>e()))));const V=e.ref("function"!=typeof t.getOptions||!!t.fields?.length);function F(e){t.getOptions?.((e=>{p.value=e||[],V.value=!0}),t.query||{},{trigger:e,change:(e,t)=>{t&&(r.value=e),O(e)},search:(e,t)=>{t&&(r.value=e),w(e),l?.search()}})}function w(e){const t=Array.isArray(e)?e:q(e);t.join("")!==i.value.join("")&&(i.value=t,b.updateWrapperQuery())}function O(e){w(e||[]),l?.insetSearch()}function q(e){if(!e&&0!==e)return[];const{valueKey:a,childrenKey:l}=t;return u(c.value,(t=>t[a]===e)).map((e=>e[a]),l).filter(Boolean)}return e.watch(V,(e=>e&&function(){const{backfill:e,field:a,fields:l}=t;if(e)if(l){const t=l.reduce(((t,a)=>(e[a]&&t.push(e[a]),t)),[]);if(t.length)return i.value=t,void b.updateWrapperQuery()}else if(e[a])return i.value=q(e[a]),void b.updateWrapperQuery();r.value?.length&&(i.value="string"==typeof r.value?q(r.value):r.value.slice(),"string"==typeof r.value&&(r.value=i.value.slice()),b.updateWrapperQuery())}()),{immediate:!0}),k.push(e.watch((()=>t.fields||[t.field]),((e,t)=>{e.toString()!==t.toString()&&l&&t.forEach((t=>e.includes(t)||l.removeUnreferencedField(t))),b.updateWrapperQuery()}))),k.push(e.watch((()=>[t.fields?.toString()||t.field,t.fields?.map((e=>t.query[e])).filter(Boolean)||t.query[t.field]]),(([e,t],[a,l])=>{e===a&&y(t)!==y(l)&&v.value&&(i.value="string"==typeof t?q(t):t)}))),k.push(e.watch((()=>t.fields?.length?t.fields.reduce(((e,a)=>(t.backfill?.[a]&&e.push(t.backfill[a]),e)),[]):t.backfill?.[t.field]),((e,t)=>{if(V.value&&y(e)!==y(t))if(m(),Array.isArray(e))w(e);else{if(!e&&0!==e)return void(i.value.length&&(i.value=[]));w(q(e))}}))),k.push(e.watch((()=>[t.depend,t.dependFields,t.dependFields&&[].concat(t.dependFields).map((e=>t.query?.[e])).join(",")||""]),(([e,t,a],[l,r,n])=>{g.value&&a!==n&&(F("depend"),e===l&&t?.toString()===r?.toString()&&i.value.length&&w("string"==typeof i.value?"":[]))}))),k.push(e.watch((()=>t.getOptions),F.bind(null,"initial"),{immediate:!0})),{wrapper:l,option:b,checked:i,getQuery:f,finalOption:c,insetDisabled:Q,insetHide:S,change:O,reset:b.reset}},exports.useWrapper=function(l){const r=[];e.onBeforeUnmount((()=>r.splice(0)));const i={};let n=!1,u=[];const o={realtime:e.ref(l.realtime),register(a){r.push(a);const o=()=>{n=!0,a.reset(),a.updateWrapperQuery();const t=r.indexOf(a);-1!==t&&r.splice(t,1),l.searchAtDatumChanged&&p(),n=!1,u.forEach((t=>{e.del(d.value,t),delete i[t]})),u=[]},s=e.getCurrentInstance();return s&&e.onBeforeUnmount(o,t?s.proxy:s),o},updateQueryValue(t,a){n&&u.push(t),e.set(d.value,t,a),i[t]=a},insetSearch(){l.realtime&&p()},search:p,removeUnreferencedField(t){let a=0;r.some((e=>(e.getQuery().hasOwnProperty(t)&&(a+=1),a))),a||(e.del(d.value,t),delete i[t])}};e.provide(a,o);const d=e.ref({...l.backfill}),s=()=>({...d.value,...l.backfill,...i});async function p(){const e=await c();e?l.toast?.(e):l.search?.(s())}async function c(){return(await Promise.all(r.map((e=>e.validator?.(d.value))))).find((e=>e&&"string"==typeof e))}return{child:r,wrapperInstance:o,query:d,getQuery:s,search:p,reset:function(){r.forEach((e=>{e.reset(),e.updateWrapperQuery()})),l.reset?.(s())},validate:c}},exports.wrapperProps=i;
//# sourceMappingURL=index.cjs.min.js.map
