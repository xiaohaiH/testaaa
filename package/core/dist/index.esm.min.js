import{version as e,onBeforeUnmount as t,ref as l,getCurrentInstance as a,set as i,del as u,provide as n,markRaw as r,computed as o,watch as d,nextTick as s,inject as p}from"vue-demi";const f="2.7"===e.slice(0,3),c="condition-wrapper";function y(e){return e}function v(e){return e}function g(e){const r=[];t((()=>r.splice(0)));const o={};let d=!1,s=[];const p={realtime:l(e.realtime),register(l){r.push(l);const i=()=>{d=!0,l.reset(),l.updateWrapperQuery();const t=r.indexOf(l);-1!==t&&r.splice(t,1),e.searchAtDatumChanged&&g(),d=!1,s.forEach((e=>{u(y.value,e),delete o[e]})),s=[]},n=a();return n&&t(i,f?n.proxy:n),i},updateQueryValue(e,t){d&&s.push(e),i(y.value,e,t),o[e]=t},insetSearch(){e.realtime&&g()},search:g,removeUnreferencedField(e){let t=0;r.some((l=>(l.getQuery().hasOwnProperty(e)&&(t+=1),t))),t||(u(y.value,e),delete o[e])}};n(c,p);const y=l({...e.backfill}),v=()=>({...y.value,...e.backfill,...o});async function g(){const t=await h();t?e.toast?.(t):e.search?.(v())}async function h(){return(await Promise.all(r.map((e=>e.validator?.(y.value))))).find((e=>e&&"string"==typeof e))}return{child:r,wrapperInstance:p,query:y,getQuery:v,search:g,reset:function(){r.forEach((e=>{e.reset(),e.updateWrapperQuery()})),e.reset?.(v())},validate:h}}const h={realtime:{type:Boolean,default:void 0},searchAtDatumChanged:{type:Boolean,default:void 0},backfill:{type:Object},toast:{type:Function,default:void 0}};function m(e,t){return Array.isArray(e)?e.filter(Boolean).length?e:t:"number"==typeof e?e:e||t}function b(e,t,l="children"){for(const a of e){if(t(a))return[a];if(a[l]?.length){const e=b(a[l],t);if(e.length)return e.unshift(a),e}}return[]}function Q(e,...t){return"function"==typeof e?e(...t):"string"==typeof e?e:r(e)}function F(e){const t=l();return o({set(e){t.value=e},get:()=>void 0===t.value?void 0!==e.defaultValue?"function"==typeof e.defaultValue?e.defaultValue(e.query,e.backfill):e.defaultValue:void 0:t.value})}function k(e,a){const i=l("boolean"==typeof e.disabled&&e.disabled),u=l("boolean"==typeof e.hide&&e.hide),n=()=>({query:e.query,backfill:e.backfill,option:a}),r=()=>{if("function"==typeof e.hide){u.value!==e.hide(n())&&(u.value=e.hide(n()))}else if("function"==typeof e.disabled){i.value!==e.disabled(n())&&(i.value=e.disabled(n()))}};let o=[d((()=>e.query),r,{immediate:!0,deep:!0}),d((()=>[e.disabled,e.hide]),((e,t)=>{e[0]!==t[0]&&(i.value="boolean"==typeof e[0]&&e[0],e[0]),e[1]!==t[1]&&(u.value="boolean"==typeof e[1]&&e[1],e[1]),r()}))];return t((()=>(o.forEach((e=>e())),o=[]))),{insetDisabled:i,insetHide:u}}function S(e=!0){const t=l(e);return{flag:t,updateFlag:()=>{t.value=!e,s((()=>{t.value=e}))}}}function V(e){return e?.toString()??""}function q(e){const a=p(c),i=F(e),u=e.backfill&&(e.fields?.length?e.fields.map((t=>e.backfill[t])).filter(Boolean):e.backfill[e.field]),n=l(u||(void 0!==e.defaultValue?i.value:e.multiple?[]:"").slice()),r=l([]),s=o((()=>r.value.length?r.value:e.options)),f=()=>e.customGetQuery?e.customGetQuery(n.value,m,e):e.multiple&&e.fields?e.fields.reduce(((t,l,a)=>(t[l]=m(n.value?.[a],e.emptyValue),t)),{}):{[e.field]:m(n.value,e.emptyValue)},{flag:y,updateFlag:v}=S(),{flag:g,updateFlag:h}=S(),b={reset(){const{multiple:t}=e;v(),h(),n.value=e.resetToInitialValue&&i.value?.slice()||(t?[]:"")},updateWrapperQuery(){v(),a&&Object.entries(f()).forEach((([e,t])=>a.updateQueryValue(e,t)))},get validator(){return e.validator},getQuery:f};a?.register(b);const{insetDisabled:Q,insetHide:q}=k(e,b);!u&&e.defaultValue&&b.updateWrapperQuery();const O=[];function A(t){e.getOptions?.((e=>{const t=n.value;n.value=void 0,r.value=e||[],n.value=t}),e.query||{},{trigger:t,change:(e,t)=>{t&&(i.value=e),W(e)},search:(e,t)=>{t&&(i.value=e),B(e),a?.search()}})}function B(e){e!==n.value&&(n.value=e,b.updateWrapperQuery())}function W(e){B(e),a?.insetSearch()}return t((()=>O.forEach((e=>e())))),O.push(d((()=>e.field),((e,t)=>{e!==t&&a?.removeUnreferencedField(t),b.updateWrapperQuery()}))),O.push(d((()=>[e.fields||e.field,e.fields?e.fields.map((t=>e.query[t])).filter(Boolean):e.query[e.field]]),(([t,l],[a])=>{const i=e.backfillToValue(l,t,e.query);t.toString()===a.toString()&&V(i)!==V(n.value)&&y.value&&(n.value=i)}))),O.push(d((()=>[e.fields||e.field,e.fields?e.fields.map((t=>e.backfill?.[t])).filter(Boolean):e.backfill?.[e.field]]),(([t,l],[a])=>{const i=e.backfillToValue(l,t,e.backfill);t.toString()===a.toString()&&V(i)!==V(n.value)&&(h(),B(i))}))),O.push(d((()=>[e.depend,e.dependFields,e.dependFields&&[].concat(e.dependFields).map((t=>e.query?.[t])).join(",")||""]),(([t,l,a],[i,u,r])=>{g.value&&a!==r&&(A("depend"),t===i&&l?.toString()===u?.toString()&&void 0!==n.value&&""!==n.value.toString()&&B(e.multiple?[]:""))}))),O.push(d((()=>e.getOptions),A.bind(null,"initial"),{immediate:!0})),{wrapper:a,option:b,checked:n,getQuery:f,insetDisabled:Q,insetHide:q,finalOption:s,updateCheckedValue:B,change:W,reset:b.reset}}const O={field:{type:String,required:!0},query:{type:Object,required:!0},backfill:{type:Object},disabled:{type:[Boolean,Function]},hide:{type:[Boolean,Function]},depend:{type:Boolean},dependFields:{type:[String,Array]},resetToInitialValue:{type:[Boolean]},emptyValue:{type:[String,Number,null,void 0]},validator:{type:[Function]},customGetQuery:{type:Function},defaultValue:{type:[String,Array,Function]}},A={...O,fields:{type:[Array]},backfillToValue:{type:Function,default:e=>e},multiple:{type:Boolean,default:void 0},options:{type:Array,default:()=>[]},getOptions:{type:Function}};function B(e){return e?.toString()??""}function W(e){const a=p(c),i=F(e),u=l([]),n=l([]),r=o((()=>n.value.length?n.value:e.options)),s=()=>O.value||i.value?e.customGetQuery?e.customGetQuery(u.value,m,e):e.fields?.length?e.fields.reduce(((t,l,a)=>Object.assign(t,{[l]:m(u.value[a],e.emptyValue)})),{}):{[e.field]:m(e.emitPath?[...u.value]:u.value.slice(-1)[0],e.emptyValue)}:{},{flag:f,updateFlag:y}=S(),{flag:v,updateFlag:g}=S(),h={reset(){return y(),g(),u.value=e.resetToInitialValue&&i.value?.slice()||[],this},get validator(){return e.validator},updateWrapperQuery(){y(),a&&Object.entries(s()).forEach((([e,t])=>a.updateQueryValue(e,t)))},getQuery:s};a?.register(h);const{insetDisabled:Q,insetHide:V}=k(e,h),q=[];t((()=>q.forEach((e=>e()))));const O=l("function"!=typeof e.getOptions||!!e.fields?.length);function A(t){e.getOptions?.((e=>{n.value=e||[],O.value=!0}),e.query||{},{trigger:t,change:(e,t)=>{t&&(i.value=e),j(e)},search:(e,t)=>{t&&(i.value=e),W(e),a?.search()}})}function W(e){const t=Array.isArray(e)?e:E(e);t.join("")!==u.value.join("")&&(u.value=t,h.updateWrapperQuery())}function j(e){W(e||[]),a?.insetSearch()}function E(t){if(!t&&0!==t)return[];const{valueKey:l,childrenKey:a}=e;return b(r.value,(e=>e[l]===t)).map((e=>e[l]),a).filter(Boolean)}return d(O,(t=>t&&function(){const{backfill:t,field:l,fields:a}=e;if(t)if(a){const e=a.reduce(((e,l)=>(t[l]&&e.push(t[l]),e)),[]);if(e.length)return u.value=e,void h.updateWrapperQuery()}else if(t[l])return u.value=E(t[l]),void h.updateWrapperQuery();i.value?.length&&(u.value="string"==typeof i.value?E(i.value):i.value.slice(),"string"==typeof i.value&&(i.value=u.value.slice()),h.updateWrapperQuery())}()),{immediate:!0}),q.push(d((()=>e.fields||[e.field]),((e,t)=>{e.toString()!==t.toString()&&a&&t.forEach((t=>e.includes(t)||a.removeUnreferencedField(t))),h.updateWrapperQuery()}))),q.push(d((()=>[e.fields?.toString()||e.field,e.fields?.map((t=>e.query[t])).filter(Boolean)||e.query[e.field]]),(([e,t],[l,a])=>{e===l&&B(t)!==B(a)&&f.value&&(u.value="string"==typeof t?E(t):t)}))),q.push(d((()=>e.fields?.length?e.fields.reduce(((t,l)=>(e.backfill?.[l]&&t.push(e.backfill[l]),t)),[]):e.backfill?.[e.field]),((e,t)=>{if(O.value&&B(e)!==B(t))if(g(),Array.isArray(e))W(e);else{if(!e&&0!==e)return void(u.value.length&&(u.value=[]));W(E(e))}}))),q.push(d((()=>[e.depend,e.dependFields,e.dependFields&&[].concat(e.dependFields).map((t=>e.query?.[t])).join(",")||""]),(([e,t,l],[a,i,n])=>{v.value&&l!==n&&(A("depend"),e===a&&t?.toString()===i?.toString()&&u.value.length&&W("string"==typeof u.value?"":[]))}))),q.push(d((()=>e.getOptions),A.bind(null,"initial"),{immediate:!0})),{wrapper:a,option:h,checked:u,getQuery:s,finalOption:r,insetDisabled:Q,insetHide:V,change:j,reset:h.reset}}const j={...O,fields:{type:[Array]},valueKey:{type:String,required:!0},childrenKey:{type:String},emitPath:{type:[Boolean],default:!1},options:{type:Array,default:()=>[]},getOptions:{type:Function}};export{f as IS_COMPOSITION_VERSION,O as commonProps,v as defineCommonMethod,y as defineProvideValue,m as emptyToValue,b as getChained,Q as getNode,A as plainProps,c as provideKey,j as treeProps,q as usePlain,W as useTree,g as useWrapper,h as wrapperProps};
//# sourceMappingURL=index.esm.min.js.map
