var VueDemi=function(e,t,i){if(e.install)return e;if(!t)return console.error("[vue-demi] no Vue instance found, please be sure to import `vue` before `vue-demi`."),e;if("2.7."===t.version.slice(0,4)){for(var n in t)e[n]=t[n];e.isVue2=!0,e.isVue3=!1,e.install=function(){},e.Vue=t,e.Vue2=t,e.version=t.version,e.warn=t.util.warn,e.hasInjectionContext=()=>!!e.getCurrentInstance(),e.createApp=function(e,i){var n,r={},u={config:t.config,use:t.use.bind(t),mixin:t.mixin.bind(t),component:t.component.bind(t),provide:function(e,t){return r[e]=t,this},directive:function(e,i){return i?(t.directive(e,i),u):t.directive(e)},mount:function(u,a){return n||((n=new t(Object.assign({propsData:i},e,{provide:Object.assign(r,e.provide)}))).$mount(u,a),n)},unmount:function(){n&&(n.$destroy(),n=void 0)}};return u}}else if("2."===t.version.slice(0,2))if(i){for(var n in i)e[n]=i[n];e.isVue2=!0,e.isVue3=!1,e.install=function(){},e.Vue=t,e.Vue2=t,e.version=t.version,e.hasInjectionContext=()=>!!e.getCurrentInstance()}else console.error("[vue-demi] no VueCompositionAPI instance found, please be sure to import `@vue/composition-api` before `vue-demi`.");else if("3."===t.version.slice(0,2)){for(var n in t)e[n]=t[n];e.isVue2=!1,e.isVue3=!0,e.install=function(){},e.Vue=t,e.Vue2=void 0,e.version=t.version,e.set=function(e,t,i){return Array.isArray(e)?(e.length=Math.max(e.length,t),e.splice(t,1,i),i):(e[t]=i,i)},e.del=function(e,t){Array.isArray(e)?e.splice(t,1):delete e[t]}}else console.error("[vue-demi] Vue version "+t.version+" is unsupported.");return e}(this.VueDemi=this.VueDemi||(void 0!==VueDemi?VueDemi:{}),this.Vue||("undefined"!=typeof Vue?Vue:void 0),this.VueCompositionAPI||("undefined"!=typeof VueCompositionAPI?VueCompositionAPI:void 0));!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("vue-demi")):"function"==typeof define&&define.amd?define(["exports","vue-demi"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).CoreCondition={},e.VueDemi)}(this,(function(e,t){"use strict";const i="2.7"===t.version.slice(0,3),n="condition-wrapper";function r(e){return e}function u(e){return e}const a={realtime:{type:Boolean,default:void 0},searchAtDatumChanged:{type:Boolean,default:void 0},backfill:{type:Object},toast:{type:Function,default:void 0}};function l(e,t){return Array.isArray(e)?e.filter(Boolean).length?e:t:"number"==typeof e?e:e||t}function o(e,t,i="children"){for(const n of e){if(t(n))return[n];if(n[i]?.length){const e=o(n[i],t);if(e.length)return e.unshift(n),e}}return[]}function s(e){const i=t.ref();return t.computed({set(e){i.value=e},get:()=>void 0===i.value?void 0!==e.defaultValue?"function"==typeof e.defaultValue?e.defaultValue(e.query,e.backfill):e.defaultValue:void 0:i.value})}function d(e,i){const n=t.ref("boolean"==typeof e.disabled&&e.disabled),r=t.ref("boolean"==typeof e.hide&&e.hide),u=()=>({query:e.query,backfill:e.backfill,option:i}),a=()=>{if("function"==typeof e.hide){r.value!==e.hide(u())&&(r.value=e.hide(u()))}else if("function"==typeof e.disabled){n.value!==e.disabled(u())&&(n.value=e.disabled(u()))}};let l=[t.watch((()=>e.query),a,{immediate:!0,deep:!0}),t.watch((()=>[e.disabled,e.hide]),((e,t)=>{e[0]!==t[0]&&(n.value="boolean"==typeof e[0]&&e[0],e[0]),e[1]!==t[1]&&(r.value="boolean"==typeof e[1]&&e[1],e[1]),a()}))];return t.onBeforeUnmount((()=>(l.forEach((e=>e())),l=[]))),{insetDisabled:n,insetHide:r}}function c(e=!0){const i=t.ref(e);return{flag:i,updateFlag:()=>{i.value=!e,t.nextTick((()=>{i.value=e}))}}}function f(e){return e?.toString()??""}const p={field:{type:String,required:!0},query:{type:Object,required:!0},backfill:{type:Object},disabled:{type:[Boolean,Function]},hide:{type:[Boolean,Function]},depend:{type:Boolean},dependFields:{type:[String,Array]},resetToInitialValue:{type:[Boolean]},emptyValue:{type:[String,Number,null,void 0]},validator:{type:[Function]},customGetQuery:{type:Function},defaultValue:{type:[String,Array,Function]}},v={...p,fields:{type:[Array]},backfillToValue:{type:Function,default:e=>e},multiple:{type:Boolean,default:void 0},options:{type:Array,default:()=>[]},getOptions:{type:Function}};function y(e){return e?.toString()??""}const h={...p,fields:{type:[Array]},valueKey:{type:String,required:!0},childrenKey:{type:String},emitPath:{type:[Boolean],default:!1},options:{type:Array,default:()=>[]},getOptions:{type:Function}};e.IS_COMPOSITION_VERSION=i,e.commonProps=p,e.defineCommonMethod=u,e.defineProvideValue=r,e.emptyToValue=l,e.getChained=o,e.getNode=function(e,...i){return"function"==typeof e?e(...i):"string"==typeof e?e:t.markRaw(e)},e.plainProps=v,e.provideKey=n,e.treeProps=h,e.usePlain=function(e){const i=t.inject(n),r=s(e),u=e.backfill&&(e.fields?.length?e.fields.map((t=>e.backfill[t])).filter(Boolean):e.backfill[e.field]),a=t.ref(u||(void 0!==e.defaultValue?r.value:e.multiple?[]:"").slice()),o=t.ref([]),p=t.computed((()=>o.value.length?o.value:e.options)),v=()=>e.customGetQuery?e.customGetQuery(a.value,l,e):e.multiple&&e.fields?e.fields.reduce(((t,i,n)=>(t[i]=l(a.value?.[n],e.emptyValue),t)),{}):{[e.field]:l(a.value,e.emptyValue)},{flag:y,updateFlag:h}=c(),{flag:g,updateFlag:m}=c(),b={reset(){const{multiple:t}=e;h(),m(),a.value=e.resetToInitialValue&&r.value?.slice()||(t?[]:"")},updateWrapperQuery(){h(),i&&Object.entries(v()).forEach((([e,t])=>i.updateQueryValue(e,t)))},get validator(){return e.validator},getQuery:v};i?.register(b);const{insetDisabled:V,insetHide:Q}=d(e,b);!u&&e.defaultValue&&b.updateWrapperQuery();const S=[];function k(t){e.getOptions?.((e=>{const t=a.value;a.value=void 0,o.value=e||[],a.value=t}),e.query||{},{trigger:t,change:(e,t)=>{t&&(r.value=e),F(e)},search:(e,t)=>{t&&(r.value=e),w(e),i?.search()}})}function w(e){e!==a.value&&(a.value=e,b.updateWrapperQuery())}function F(e){w(e),i?.insetSearch()}return t.onBeforeUnmount((()=>S.forEach((e=>e())))),S.push(t.watch((()=>e.field),((e,t)=>{e!==t&&i?.removeUnreferencedField(t),b.updateWrapperQuery()}))),S.push(t.watch((()=>[e.fields||e.field,e.fields?e.fields.map((t=>e.query[t])).filter(Boolean):e.query[e.field]]),(([t,i],[n])=>{const r=e.backfillToValue(i,t,e.query);t.toString()===n.toString()&&f(r)!==f(a.value)&&y.value&&(a.value=r)}))),S.push(t.watch((()=>[e.fields||e.field,e.fields?e.fields.map((t=>e.backfill?.[t])).filter(Boolean):e.backfill?.[e.field]]),(([t,i],[n])=>{const r=e.backfillToValue(i,t,e.backfill);t.toString()===n.toString()&&f(r)!==f(a.value)&&(m(),w(r))}))),S.push(t.watch((()=>[e.depend,e.dependFields,e.dependFields&&[].concat(e.dependFields).map((t=>e.query?.[t])).join(",")||""]),(([t,i,n],[r,u,l])=>{g.value&&n!==l&&(k("depend"),t===r&&i?.toString()===u?.toString()&&void 0!==a.value&&""!==a.value.toString()&&w(e.multiple?[]:""))}))),S.push(t.watch((()=>e.getOptions),k.bind(null,"initial"),{immediate:!0})),{wrapper:i,option:b,checked:a,getQuery:v,insetDisabled:V,insetHide:Q,finalOption:p,updateCheckedValue:w,change:F,reset:b.reset}},e.useTree=function(e){const i=t.inject(n),r=s(e),u=t.ref([]),a=t.ref([]),f=t.computed((()=>a.value.length?a.value:e.options)),p=()=>k.value||r.value?e.customGetQuery?e.customGetQuery(u.value,l,e):e.fields?.length?e.fields.reduce(((t,i,n)=>Object.assign(t,{[i]:l(u.value[n],e.emptyValue)})),{}):{[e.field]:l(e.emitPath?[...u.value]:u.value.slice(-1)[0],e.emptyValue)}:{},{flag:v,updateFlag:h}=c(),{flag:g,updateFlag:m}=c(),b={reset(){return h(),m(),u.value=e.resetToInitialValue&&r.value?.slice()||[],this},get validator(){return e.validator},updateWrapperQuery(){h(),i&&Object.entries(p()).forEach((([e,t])=>i.updateQueryValue(e,t)))},getQuery:p};i?.register(b);const{insetDisabled:V,insetHide:Q}=d(e,b),S=[];t.onBeforeUnmount((()=>S.forEach((e=>e()))));const k=t.ref("function"!=typeof e.getOptions||!!e.fields?.length);function w(t){e.getOptions?.((e=>{a.value=e||[],k.value=!0}),e.query||{},{trigger:t,change:(e,t)=>{t&&(r.value=e),A(e)},search:(e,t)=>{t&&(r.value=e),F(e),i?.search()}})}function F(e){const t=Array.isArray(e)?e:O(e);t.join("")!==u.value.join("")&&(u.value=t,b.updateWrapperQuery())}function A(e){F(e||[]),i?.insetSearch()}function O(t){if(!t&&0!==t)return[];const{valueKey:i,childrenKey:n}=e;return o(f.value,(e=>e[i]===t)).map((e=>e[i]),n).filter(Boolean)}return t.watch(k,(t=>t&&function(){const{backfill:t,field:i,fields:n}=e;if(t)if(n){const e=n.reduce(((e,i)=>(t[i]&&e.push(t[i]),e)),[]);if(e.length)return u.value=e,void b.updateWrapperQuery()}else if(t[i])return u.value=O(t[i]),void b.updateWrapperQuery();r.value?.length&&(u.value="string"==typeof r.value?O(r.value):r.value.slice(),"string"==typeof r.value&&(r.value=u.value.slice()),b.updateWrapperQuery())}()),{immediate:!0}),S.push(t.watch((()=>e.fields||[e.field]),((e,t)=>{e.toString()!==t.toString()&&i&&t.forEach((t=>e.includes(t)||i.removeUnreferencedField(t))),b.updateWrapperQuery()}))),S.push(t.watch((()=>[e.fields?.toString()||e.field,e.fields?.map((t=>e.query[t])).filter(Boolean)||e.query[e.field]]),(([e,t],[i,n])=>{e===i&&y(t)!==y(n)&&v.value&&(u.value="string"==typeof t?O(t):t)}))),S.push(t.watch((()=>e.fields?.length?e.fields.reduce(((t,i)=>(e.backfill?.[i]&&t.push(e.backfill[i]),t)),[]):e.backfill?.[e.field]),((e,t)=>{if(k.value&&y(e)!==y(t))if(m(),Array.isArray(e))F(e);else{if(!e&&0!==e)return void(u.value.length&&(u.value=[]));F(O(e))}}))),S.push(t.watch((()=>[e.depend,e.dependFields,e.dependFields&&[].concat(e.dependFields).map((t=>e.query?.[t])).join(",")||""]),(([e,t,i],[n,r,a])=>{g.value&&i!==a&&(w("depend"),e===n&&t?.toString()===r?.toString()&&u.value.length&&F("string"==typeof u.value?"":[]))}))),S.push(t.watch((()=>e.getOptions),w.bind(null,"initial"),{immediate:!0})),{wrapper:i,option:b,checked:u,getQuery:p,finalOption:f,insetDisabled:V,insetHide:Q,change:A,reset:b.reset}},e.useWrapper=function(e){const r=[];t.onBeforeUnmount((()=>r.splice(0)));const u={};let a=!1,l=[];const o={realtime:t.ref(e.realtime),register(n){r.push(n);const o=()=>{a=!0,n.reset(),n.updateWrapperQuery();const i=r.indexOf(n);-1!==i&&r.splice(i,1),e.searchAtDatumChanged&&c(),a=!1,l.forEach((e=>{t.del(s.value,e),delete u[e]})),l=[]},d=t.getCurrentInstance();return d&&t.onBeforeUnmount(o,i?d.proxy:d),o},updateQueryValue(e,i){a&&l.push(e),t.set(s.value,e,i),u[e]=i},insetSearch(){e.realtime&&c()},search:c,removeUnreferencedField(e){let i=0;r.some((t=>(t.getQuery().hasOwnProperty(e)&&(i+=1),i))),i||(t.del(s.value,e),delete u[e])}};t.provide(n,o);const s=t.ref({...e.backfill}),d=()=>({...s.value,...e.backfill,...u});async function c(){const t=await f();t?e.toast?.(t):e.search?.(d())}async function f(){return(await Promise.all(r.map((e=>e.validator?.(s.value))))).find((e=>e&&"string"==typeof e))}return{child:r,wrapperInstance:o,query:s,getQuery:d,search:c,reset:function(){r.forEach((e=>{e.reset(),e.updateWrapperQuery()})),e.reset?.(d())},validate:f}},e.wrapperProps=a}));
//# sourceMappingURL=index.umd.min.js.map
